<apex:page id="collateralEditPage" standardController="Lending_Application_Collateral__c"
           extensions="CollateralEditController" tabStyle="Lending_Application_Collateral__c"
           showHeader="true" applyHtmlTag="true" docType="html-5.0"
           title="{!$Label.fscore__edit_lending_app_collateral_title}">

    <head>
        <apex:slds />
        <apex:stylesheet value="{!URLFOR($Resource.fs_style, 'fs-style.css')}"/>
        <script src="{!URLFOR($Resource.fs_svg, 'svg4everybody.js')}"></script>
        <script>svg4everybody();</script>
        <meta http-equiv="x-ua-compatible" content="ie=edge"/>
        <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" />
        <script>var $j = jQuery.noConflict();</script>
    </head>   

    <body>   
        <div class="slds-scope">
            <apex:form id="appCollateralEditForm" styleClass="slds-form_horizontal fs-data-form slds-m-horizontal_x-small slds-m-bottom_large">

                <div id="page-sticky-anchor"></div>
                <div id="page-sticky-header">
                    <div class="slds-page-header slds-m-bottom--small" role="banner">
                        <div class="slds-grid slds-grid--align-spread">
                            <div class="slds-col" align="left">
                                <div class="slds-media">
                                    <div class="slds-media__figure">
                                       <c:svgIcon iconStyleClass="slds-icon slds-icon--large slds-icon-standard-apps"
                                                  iconPath="{!URLFOR($Asset.SLDS, 'assets/icons/custom-sprite/svg/symbols.svg#custom18')}"/>
                                    </div>
                                    <div class="slds-media__body slds-align-middle">
                                        <p class="slds-text-heading--label">{!mApplication.Name}</p>
                                        <h1 class="slds-page-header__title slds-m-right--small slds-truncate slds-align-middle">
                                            {!IF(ISBLANK(mAppCollateralObj.mApplicationCollateral.Id)
                                                       , $Label.fscore__new_lending_app_collateral_title
                                                       , ($ObjectType.Lending_Application_Collateral__c.Fields.Name.Label + mAppCollateralObj.mApplicationCollateral.Name))}
                                      
                                        </h1>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="slds-col slds-no-flex slds-align-middle">
                                <apex:commandButton value="{!$Label.fscore__save_button}" 
                                                    title="{!$Label.fscore__save_button_tooltip}"
                                                    styleClass="slds-button slds-button--brand"
                                                    action="{!onSave}" 
                                                    status="waitStatus"
                                                    reRender="messagePanel,appCollateralBlockPanel"/>
                                                    
                                <apex:commandButton immediate="true" action="{!cancel}"
                                                    value="{!$Label.fscore__cancel_button}" 
                                                    title="{!$Label.fscore__cancel_button_tooltip}"
                                                    styleClass="slds-button slds-button--neutral"/>
                            </div>
                        </div>
                    </div>
                </div>
                
                <apex:actionStatus id="waitStatus">
                    <apex:facet name="start">
                        <c:fsSpinner spinnerSize="medium"/>
                    </apex:facet>
                </apex:actionStatus>

                <apex:actionStatus id="newCollateralStatus">
                    <apex:facet name="start">
                        <c:fsWaitMessage messageText="{!$Label.fscore__adding_new_collateral_action_status_title}"/>
                    </apex:facet>
                </apex:actionStatus>

                <apex:actionStatus id="collateralReloadStatus">
                    <apex:facet name="start">
                        <c:fsWaitMessage messageText="{!$Label.fscore__reloading_action_status_title}"/>
                    </apex:facet>
                </apex:actionStatus>

                <apex:outputPanel id="messagePanel" styleClass="fs-message-panel">
                    <apex:pagemessages />
                </apex:outputPanel>          

                <div class="slds-m-top--small">
                    <div class="slds-box slds-box--x-small slds-container--fluid">
                        <apex:outputPanel id="appCollateralBlockPanel">
                            <apex:pageBlock id="appCollateralPageBlock" mode="mainDetail" html-class="fs-data-block">

                                <!-- Hidden field for holding value required for adding a new collateral -->
                                <apex:inputHidden id="iNewCollateralId" value="{!mNewCollateralId}"/>
                                
                                <apex:outputPanel id="applicationInfoPanel">
                                    <c:sectionHeader label="{!$Label.fscore__information_block_title}"
                                                     isEditSectionHeader="true" isModalWindow="true"/>
    
                                    <apex:pageBlockSection columns="2" collapsible="false" html-class="slds-theme--default">
                                        <apex:pageBlockSectionItem >
                                            <apex:outputLabel value="{!$ObjectType.Lending_Application_Collateral__c.Fields.Collateral_Family__c.Label}"></apex:outputLabel>
                                            <apex:outputField value="{!mAppCollateralObj.mApplicationCollateral.Collateral_Family__c}"/>
                                        </apex:pageBlockSectionItem>

                                        <apex:pageBlockSectionItem >
                                            <apex:outputLabel value="{!$ObjectType.Lending_Application_Collateral__c.Fields.Collateral_Sub_Family__c.Label}"></apex:outputLabel>
                                            <apex:outputField value="{!mAppCollateralObj.mApplicationCollateral.Collateral_Sub_Family__c}"/>
                                        </apex:pageBlockSectionItem>
                                    </apex:pageBlockSection>
 
                                </apex:outputPanel>

                                <apex:outputPanel id="appCollateralInfoPanel">
                                    <div class="slds-m-top--small">
                                        <c:sectionHeader label="{!$Label.fscore__contract_collateral_info_block_title}"
                                                         isEditSectionHeader="true" isModalWindow="true"/>
                                    </div>
                                    
                                    <c:lendingAppCollateralEdit applicationCollateral="{!mAppCollateralObj}"/>
 
                                </apex:outputPanel>
                            </apex:pageBlock>
                        </apex:outputPanel>
                    </div>
                </div>
                
                <apex:actionFunction name="addNewCollateralToApplication"
                                     action="{!onAddNewCollateral}"
                                     reRender="messagePanel,appCollateralBlockPanel"
                                     status="newCollateralStatus"/>
                                     
                <apex:actionFunction name="reloadCollateralDetails"
                                     action="{!onReloadDetails}"
                                     reRender="messagePanel,appCollateralBlockPanel"
                                     status="collateralReloadStatus"/>

            </apex:form>
            <c:fsCopyright pageTitle="{!IF(ISBLANK(mAppCollateralObj.mApplicationCollateral.Id)
                                         , $Label.fscore__new_lending_app_collateral_title
                                         , ($ObjectType.Lending_Application_Collateral__c.Fields.Name.Label + mAppCollateralObj.mApplicationCollateral.Name))}"/>
        </div>

        <c:fsModalWindow /> 
        <script src="{!URLFOR($Resource.fs_sticky_header, 'fs_sticky_header.js')}"/>

        <script>
            function addNewCollateral(collateralId, appCollateralKey){
                console.log('I/P collateral Id ' + collateralId);
                console.log('I/P Application collateral key ' + appCollateralKey);
                $j('input[id$=iNewCollateralId]').val(collateralId);
                addNewCollateralToApplication();
            }     
        </script>
    </body>

</apex:page>
