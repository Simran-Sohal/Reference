<apex:page id="collateralMasterEditPage" standardController="Collateral__c"
           extensions="CollateralMasterEditController" tabStyle="Collateral__c"
           showHeader="{!NOT(mIsModalWindow)}" sidebar="{!NOT(mIsModalWindow)}"
           title="{!$Label.fscore__edit_collateral_title}" applyHtmlTag="true" docType="html-5.0" >

    <head>
        <apex:slds />
        <apex:stylesheet value="{!URLFOR($Resource.fs_style, 'fs-style.css')}"/>
        <script src="{!URLFOR($Resource.fs_svg, 'svg4everybody.js')}"></script>
        <script>svg4everybody();</script>
        <meta http-equiv="x-ua-compatible" content="ie=edge"/>
        <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" />
        <script>var $j = jQuery.noConflict();</script>
    </head>   

    <body>   
        <div class="slds-scope">
            <apex:form id="collateralEditForm" styleClass="slds-form_horizontal fs-data-form slds-m-bottom_large slds-m-horizontal_x-small">
                
                <div id="modal-sticky-anchor"></div>
                <div id="modal-sticky-header">
                    <div class="slds-page-header slds-m-bottom--small" role="banner">
                        <div class="slds-grid slds-grid--align-spread">
                            <div class="slds-col" align="left">
                                <div class="slds-media">
                                    <div class="slds-media__figure">
                                       <c:svgIcon iconStyleClass="slds-icon {!IF(mIsModalWindow,'slds-icon--medium','slds-icon--large')} slds-icon-standard-document"
                                                  iconPath="{!URLFOR($Asset.SLDS, 'assets/icons/custom-sprite/svg/symbols.svg#custom91')}"/>
                                    </div>
                                    <div class="slds-media__body slds-align-middle">
                                        <p class="slds-text-heading--label">{!$ObjectType.Collateral__c.Label}</p>
                                        <h1 class="slds-page-header__title slds-m-right--small slds-truncate slds-align-middle">
                                            {!IF(ISBLANK(mCollateral.Id), $Label.fscore__new_collateral_title, mCollateral.Name)}
                                        </h1>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="slds-col slds-no-flex slds-align-middle">
                                <apex:commandButton value="{!$Label.fscore__save_button}" 
                                                    title="{!$Label.fscore__save_button_tooltip}"
                                                    styleClass="slds-button slds-button--brand"
                                                    action="{!onSave}" 
                                                    status="saveRecordStatus"
                                                    reRender="messagePanel,collateralInfoPanel"
                                                    oncomplete="{!mJavascriptMethodName}('{!mCollateral.Id}', '{!mAppCollateralKey}', {!mIsModalWindow}, {!mIsError});"/>
                                                    
                                <apex:commandButton immediate="true" action="{!cancel}"
                                                    value="{!$Label.fscore__cancel_button}" 
                                                    title="{!$Label.fscore__cancel_button_tooltip}"
                                                    styleClass="slds-button slds-button--neutral"
                                                    onclick="closeModalFromModalWindow('cancel',false,{!mIsModalWindow},'');"/>
                            </div>
                        </div>
                    </div>
                </div>
                
                <apex:actionStatus id="saveRecordStatus">
                    <apex:facet name="start">
                        <c:fsSpinner spinnerSize="medium"/>
                    </apex:facet>
                </apex:actionStatus>

                <apex:outputPanel id="messagePanel" styleClass="fs-message-panel">
                    <apex:pagemessages />
                </apex:outputPanel>          

                <div class="slds-m-top--small">
                    <div class="{!IF(mIsModalWindow,'', 'slds-box slds-box--x-small')} slds-container--fluid">
                    <apex:pageBlock id="collateralPageBlock" mode="mainDetail" html-class="fs-data-block">
                        
                        <apex:outputPanel id="collateralInfoPanel">
                            <c:sectionHeader label="{!$Label.fscore__information_block_title}"
                                             isEditSectionHeader="true" isModalWindow="true"/>

                            <apex:pageBlockSection id="generalInfoSection" columns="2" collapsible="false"  html-class="slds-theme--default">
                                <apex:pageBlockSectionItem rendered="{!ISBLANK(mCollateral.Id)}">
                                    <apex:outputLabel value="{!$ObjectType.Collateral__c.Fields.Name.Label}"></apex:outputLabel>
                                    <apex:outputText value="{!$Label.fscore__new_record_title}"/>
                                </apex:pageBlockSectionItem>
                                <apex:outputField value="{!mCollateral.Name}" rendered="{!NOT(ISBLANK(mCollateral.Id))}"/>
                                
                                <apex:pageBlockSectionItem helpText="{!$ObjectType.Collateral__c.Fields.Status__c.inlineHelpText}" >
                                    <apex:outputLabel value="{!$ObjectType.Collateral__c.Fields.Status__c.Label}">
                                        <apex:outputPanel styleClass="slds-m-left--xxx-small fs-required">*</apex:outputPanel>
                                    </apex:outputLabel>
                                    <apex:inputField value="{!mCollateral.Status__c}" required="false"/>
                                </apex:pageBlockSectionItem>

                                <apex:pageBlockSectionItem helpText="{!$ObjectType.Collateral__c.Fields.Collateral_Family__c.inlineHelpText}" >
                                    <apex:outputLabel value="{!$ObjectType.Collateral__c.Fields.Collateral_Family__c.Label}">
                                        <apex:outputPanel styleClass="slds-m-left--xxx-small fs-required">*</apex:outputPanel>
                                    </apex:outputLabel>
                                    <apex:inputField value="{!mCollateral.Collateral_Family__c}" required="false"/>
                                </apex:pageBlockSectionItem>
                                
                                <apex:inputField value="{!mCollateral.Collateral_Sub_Family__c}"/>                    
                                
                                <apex:inputField value="{!mCollateral.Description__c}"/>
                                <apex:inputField value="{!mCollateral.Is_Active__c}"/>                    
                            </apex:pageBlockSection>
                            
                            <div class="slds-m-top--small">
                                <c:sectionHeader label="{!$Label.fscore__contract_collateral_info_block_title}"
                                                 isEditSectionHeader="true" isModalWindow="true"/>
                            </div>
                            
                            <!-- Auto -->
                            <apex:pageBlockSection id="autoInfoSection" columns="2" collapsible="false" html-class="slds-theme--default"
                                                   rendered="{!(mCollateralRecordTypeName == 'Auto')}" >
                                <apex:repeat value="{!$ObjectType.Collateral__c.FieldSets.Collateral_Auto_Fields}"
                                               var="autoInfo">
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value="{!autoInfo.label}">
                                            <apex:outputPanel rendered="{!OR(autoInfo.required, autoInfo.dbRequired)}" 
                                                              styleClass="slds-m-left--xxx-small fs-required">*</apex:outputPanel>
                                        </apex:outputLabel>
                                        <apex:inputField value="{!mCollateral[autoInfo.fieldPath]}" required="false"/>
                                    </apex:pageBlockSectionItem>
                                </apex:repeat>
                            </apex:pageBlockSection>

                            <!-- Equipment -->
                            <apex:pageBlockSection id="equipmentInfoSection" columns="2" collapsible="false" html-class="slds-theme--default"
                                                   rendered="{!(mCollateralRecordTypeName == 'Equipment')}" >
                                <apex:repeat value="{!$ObjectType.Collateral__c.FieldSets.Collateral_Equipment_Fields}"
                                               var="equipmentInfo">
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value="{!equipmentInfo.label}">
                                            <apex:outputPanel rendered="{!OR(equipmentInfo.required, equipmentInfo.dbRequired)}" 
                                                              styleClass="slds-m-left--xxx-small fs-required">*</apex:outputPanel>
                                        </apex:outputLabel>
                                        <apex:inputField value="{!mCollateral[equipmentInfo.fieldPath]}" required="false"/>
                                    </apex:pageBlockSectionItem>
                                </apex:repeat>
                            </apex:pageBlockSection>
                            
                            <!-- Home -->
                            <apex:pageBlockSection id="homeInfoSection" columns="2" collapsible="false" html-class="slds-theme--default"
                                                   rendered="{!(mCollateralRecordTypeName == 'Home')}" >
                                <apex:repeat value="{!$ObjectType.Collateral__c.FieldSets.Collateral_Home_Fields}"
                                             var="homeInfo">
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value="{!homeInfo.label}">
                                            <apex:outputPanel rendered="{!OR(homeInfo.required, homeInfo.dbRequired)}" 
                                                              styleClass="slds-m-left--xxx-small fs-required">*</apex:outputPanel>
                                        </apex:outputLabel>
                                        <apex:inputField value="{!mCollateral[homeInfo.fieldPath]}" required="false"/>
                                    </apex:pageBlockSectionItem>
                                </apex:repeat>
                            </apex:pageBlockSection>
                            
                            <!-- Other -->
                            <apex:pageBlockSection id="otherInfoSection" columns="2" collapsible="false" html-class="slds-theme--default"
                                                   rendered="{!(mCollateralRecordTypeName == 'Other')}" >
                                <apex:repeat value="{!$ObjectType.Collateral__c.FieldSets.Collateral_Other_Fields}"
                                             var="otherInfo">
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value="{!otherInfo.label}">
                                            <apex:outputPanel rendered="{!OR(otherInfo.required, otherInfo.dbRequired)}" 
                                                              styleClass="slds-m-left--xxx-small fs-required">*</apex:outputPanel>
                                        </apex:outputLabel>
                                        <apex:inputField value="{!mCollateral[otherInfo.fieldPath]}" required="false"/>
                                    </apex:pageBlockSectionItem>
                                </apex:repeat>
                            </apex:pageBlockSection>                                
                            
                            <div class="slds-m-top--small">
                                <c:sectionHeader label="{!$Label.fscore__collateral_lien_info_section_title}"
                                                 isEditSectionHeader="true" isModalWindow="true"/>
                            </div>

                            <apex:pageBlockSection id="lienInfoSection" columns="2" collapsible="false" html-class="slds-theme--default">
                                <apex:inputField value="{!mCollateral.Lien_Date__c}"/>                    
                                <apex:inputField value="{!mCollateral.Lien_Notes__c}"/>
                            </apex:pageBlockSection>
                            
                        </apex:outputPanel>
                        
                    </apex:pageBlock>
                    </div>
                </div>
            </apex:form>
            <div class="{!IF(mIsModalWindow,'slds-hide','')}">
                <c:fsCopyright pageTitle="{!IF(ISBLANK(mCollateral.Id), $Label.fscore__new_collateral_title, mCollateral.Name)}"/>
            </div>
        </div>

        <script src="{!$Resource.fs_modal_window_close_js}"/>
        <script src="{!URLFOR($Resource.fs_modal_sticky_header, 'fs_modal_sticky_header.js')}"/>
        <script>
            /*
             * SSingh : Do Not rename the following method names
             */
            function setCollateralDetails(collateralId, appCollateralKey, isModalWindow, isError){
                console.log('setting collateral details...');
                closeModalFromModalWindow('save', isError, isModalWindow, 'reloadCollateralDetails');
            }

            function setNewCollateralDetails(collateralId, appCollateralKey, isModalWindow, isError){
                if (isModalWindow){
                    if (!isError){
                        console.log('adding new collateral...');
                        console.log('New Collateral Id : ' + collateralId);
                        console.log('App Collateral key : ' + appCollateralKey);

                        if (collateralId){
                            try{
                                var savePrntWindow = window.parent;
                                while (savePrntWindow.addNewCollateral == null && savePrntWindow != top) {
                                    savePrntWindow = prnt.parent;
                                };
                                savePrntWindow.addNewCollateral(collateralId, appCollateralKey);
                            }
                            catch(err){
                                console.log(err.message);
                            }
                        }
                        console.log('closing window...');
                        window.parent.parent.closeModal('save');
                    }
                }
            }
        </script>
    </body>
</apex:page>
