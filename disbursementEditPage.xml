<apex:page id="disbursementEditPage" standardController="Lending_Application_Disbursement__c"
           extensions="DisbursementEditController" tabStyle="Lending_Application_Disbursement__c"
           showHeader="true" sidebar="true" applyHtmlTag="true" docType="html-5.0"
           title="{!$Label.fscore__edit_lending_app_disbursement_title}">

    <head>
        <apex:slds />
        <apex:stylesheet value="{!URLFOR($Resource.fs_style, 'fs-style.css')}"/>
        <meta http-equiv="x-ua-compatible" content="ie=edge"/>
        <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"/>
        <script src="{!URLFOR($Resource.fs_svg, 'svg4everybody.js')}"></script>
        <script>
            svg4everybody();
            var $j = jQuery.noConflict();
        </script>
    </head>   
        
    <body>   
        <div class="slds-scope">
            <apex:form id="disbursementEditForm" styleClass="slds-form_horizontal fs-data-form slds-m-horizontal_x-small slds-m-bottom_large">

                <div id="page-sticky-anchor"></div>
                <div id="page-sticky-header">
                    <div class="slds-page-header slds-m-bottom--small" role="banner">
                        <div class="slds-grid slds-grid--align-spread">
                            <div class="slds-col" align="left">
                                <div class="slds-media">
                                    <div class="slds-media__figure">
                                       <c:svgIcon iconStyleClass="slds-icon slds-icon--large slds-icon-standard-apps"
                                                  iconPath="{!URLFOR($Asset.SLDS, 'assets/icons/custom-sprite/svg/symbols.svg#custom18')}"/>
                                    </div>
                                    <div class="slds-media__body slds-align-middle">
                                        <p class="slds-text-heading--label">{!mApplication.Name}</p>
                                        <h1 class="slds-page-header__title slds-m-right--small slds-truncate slds-align-middle">
                                            {!IF(ISBLANK(mAppDisbObject.mDisbursement.Id)
                                                       , $Label.fscore__new_lending_app_disbursement_title
                                                       , ($ObjectType.Lending_Application_Disbursement__c.Fields.Name.Label + mAppDisbObject.mDisbursement.Name))}
                                        </h1>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="slds-col slds-no-flex slds-align-middle">
                                <apex:commandButton value="{!$Label.fscore__save_button}" 
                                                    title="{!$Label.fscore__save_button_tooltip}"
                                                    styleClass="slds-button slds-button--brand"
                                                    action="{!onSave}" 
                                                    status="waitStatus"
                                                    reRender="messagePanel,disbursementBlockPanel"/>
                                                    
                                <apex:commandButton immediate="true" action="{!cancel}"
                                                    value="{!$Label.fscore__cancel_button}" 
                                                    title="{!$Label.fscore__cancel_button_tooltip}"
                                                    styleClass="slds-button slds-button--neutral"/>
                            </div>
                        </div>
                    </div>
                </div>
                    
                <apex:actionStatus id="waitStatus">
                    <apex:facet name="start">
                        <c:fsSpinner spinnerSize="medium"/>
                    </apex:facet>
                </apex:actionStatus>

                <apex:outputPanel id="messagePanel" styleClass="fs-message-panel">
                    <apex:pagemessages />
                </apex:outputPanel>          
    
                <div class="slds-box slds-box_x-small slds-container_fluid slds-m-top_small">
                    <apex:outputPanel id="disbursementBlockPanel">
                        <apex:pageBlock id="disbursementPageBlock" mode="mainDetail" html-class="fs-data-block">
                            <apex:outputPanel id="partyInfoPanel">
                                <c:sectionHeader label="{!$Label.fscore__party_info_section_title}"
                                                 isEditSectionHeader="true" isModalWindow="true"/>
                                
                                <div id="partyInfoSection" class="slds-grid slds-wrap slds-m-horizontal_small">
                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3 slds-truncate">
                                        <p class="slds-text-body_small slds-text-color_weak slds-p-bottom_xx-small">
                                            <span class="slds-truncate">{!$ObjectType.Lending_Application_Disbursement__c.Fields.Disbursement_Party_Type__c.Label}</span>
                                            <apex:outputPanel styleClass="fs-required slds-m-left_xx-small">*</apex:outputPanel>
                                        </p>
                                        <apex:inputField value="{!mAppDisbObject.mDisbursement.Disbursement_Party_Type__c}"
                                                         onchange="handlePartyTypeChange();"/>
                                    </div>
                                    
                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3 slds-truncate">
                                        <p class="slds-text-body_small slds-text-color_weak slds-p-bottom_xx-small">
                                            <span class="slds-truncate">{!$Label.fscore__customer_field_label}</span>
                                            <apex:outputPanel rendered="{!(mAppDisbObject.isCustomer)}" styleClass="fs-required slds-m-left_xx-small">*</apex:outputPanel>
                                        </p>
                                        <apex:outputText value="--" rendered="{!NOT(mAppDisbObject.isCustomer)}"/>
                                        <apex:outputPanel rendered="{!(mAppDisbObject.isCustomer)}">
	                                        <apex:selectList value="{!mAppDisbObject.mDisbursement.Customer_Reference_Number__c}"
	                                                         multiselect="false" size="1"
	                                                         onchange="handleCustomerChange();">
	                                            <apex:selectOptions value="{!mAppDisbObject.customerList}"/>
	                                        </apex:selectList>
                                        </apex:outputPanel>
                                    </div>

                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3 slds-truncate">
                                        <p class="slds-text-body_small slds-text-color_weak slds-p-bottom_xx-small">
                                            <span class="slds-truncate">{!$ObjectType.Lending_Application_Disbursement__c.Fields.Account_Name__c.Label}</span>
                                        </p>
                                        <apex:outputField value="{!mAppDisbObject.mDisbursement.Account_Name__c}" rendered="{!(mAppDisbObject.isCustomer)}"/>
                                        <apex:inputField value="{!mAppDisbObject.mDisbursement.Account_Name__c}" rendered="{!NOT(mAppDisbObject.isCustomer)}"
                                                         onchange="handleAccountChange();"/>
                                    </div>

                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3 slds-truncate">
                                        <p class="slds-text-body_small slds-text-color_weak slds-p-bottom_xx-small">
                                            <span class="slds-truncate">{!$ObjectType.Lending_Application_Disbursement__c.Fields.Contact_Name__c.Label}</span>
                                        </p>
                                        <apex:outputField value="{!mAppDisbObject.mDisbursement.Contact_Name__c}" rendered="{!(mAppDisbObject.isCustomer)}"/>
                                        <apex:outputPanel rendered="{!NOT(mAppDisbObject.isCustomer)}">
                                            <apex:selectList value="{!mAppDisbObject.mDisbursement.Contact_Name__c}"
                                                             multiselect="false" size="1"
                                                             onchange="handleContactChange();"
                                                             rendered="{!NOT(ISBLANK(mAppDisbObject.mDisbursement.Account_Name__c))}">
                                                <apex:selectOptions value="{!mAppDisbObject.accountContactList}"/>
                                            </apex:selectList>
                
                                            <apex:inputField value="{!mAppDisbObject.mDisbursement.Contact_Name__c}"
                                                             rendered="{!ISBLANK(mAppDisbObject.mDisbursement.Account_Name__c)}"
                                                             onchange="handleContactChange();"/>
                                        </apex:outputPanel>
                                    </div>
                                </div>
                            </apex:outputPanel>                            

                            <apex:outputPanel id="disbursementInfoPanel">
                                <div class="slds-m-top_small">
                                    <c:sectionHeader label="{!$Label.fscore__disbursement_info_section_title}"
                                                     isEditSectionHeader="true" isModalWindow="true"/>
                                </div>

                                <div id="disbursementInfoSection" class="slds-grid slds-wrap slds-m-horizontal_small">
                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3 slds-truncate">
                                        <p class="slds-text-body_small slds-text-color_weak slds-p-bottom_xx-small">
                                            <span class="slds-truncate">{!$ObjectType.Lending_Application_Disbursement__c.Fields.Disbursement_Amount__c.Label}</span>
                                            <apex:outputPanel styleClass="fs-required slds-m-left_xx-small">*</apex:outputPanel>
                                        </p>
                                        <apex:inputField value="{!mAppDisbObject.mDisbursement.Disbursement_Amount__c}"/>
                                    </div>

                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3 slds-truncate">
                                        <p class="slds-text-body_small slds-text-color_weak slds-p-bottom_xx-small">
                                            <span class="slds-truncate">{!$ObjectType.Lending_Application_Disbursement__c.Fields.Payment_Method__c.Label}</span>
                                            <apex:outputPanel styleClass="fs-required slds-m-left_xx-small">*</apex:outputPanel>
                                        </p>
                                        <apex:inputField value="{!mAppDisbObject.mDisbursement.Payment_Method__c}"
                                                         onchange="handlePaymentMethodChange();"/>
                                    </div>

                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3 slds-truncate">
                                        <p class="slds-text-body_small slds-text-color_weak slds-p-bottom_xx-small">
                                            <span class="slds-truncate">{!$ObjectType.Lending_Application_Disbursement__c.Fields.Reference__c.Label}</span>
                                        </p>
                                        <apex:inputField value="{!mAppDisbObject.mDisbursement.Reference__c}"/>
                                    </div>

                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3 slds-truncate">
                                        <p class="slds-text-body_small slds-text-color_weak slds-p-bottom_xx-small">
                                            <span class="slds-truncate">{!$ObjectType.Lending_Application_Disbursement__c.Fields.Is_Future_Disbursement__c.Label}</span>
                                        </p>
                                        <apex:outputText value="--" rendered="{!NOT(mApplication.Is_Funding_In_Tranches_Allowed__c)}"/>
                                        <apex:inputField value="{!mAppDisbObject.mDisbursement.Is_Future_Disbursement__c}"
                                                         rendered="{!mApplication.Is_Funding_In_Tranches_Allowed__c}"
                                                         onchange="handleFutureFlagChange();"/>
                                    </div>

                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3 slds-truncate">
                                        <p class="slds-text-body_small slds-text-color_weak slds-p-bottom_xx-small">
                                            <span class="slds-truncate">{!$ObjectType.Lending_Application_Disbursement__c.Fields.Disbursement_Date_Formula__c.Label}</span>
                                            <apex:outputPanel rendered="{!mAppDisbObject.mDisbursement.Is_Future_Disbursement__c}" 
                                                              styleClass="fs-required slds-m-left_xx-small">*</apex:outputPanel>
                                        </p>
                                        <apex:outputText value="--" rendered="{!NOT(mAppDisbObject.mDisbursement.Is_Future_Disbursement__c)}"/>
                                        <apex:inputField value="{!mAppDisbObject.mDisbursement.Future_Disbursement_Date__c}"
                                                         rendered="{!mAppDisbObject.mDisbursement.Is_Future_Disbursement__c}"
                                                         onchange="handlePaymentMethodChange();"/>
                                    </div>
                                </div>
                            </apex:outputPanel>                            

                            <apex:outputPanel id="electonicPaymentInfoPanel" rendered="{!mAppDisbObject.isElectronicPayment}">
                                <div class="slds-m-top_small">
                                    <c:sectionHeader label="{!$Label.fscore__bank_account_section_title}"
                                                     isEditSectionHeader="true" isModalWindow="true"/>
                                </div>

                                <div id="ePmtInfoSectionInternal" class="slds-grid slds-wrap slds-m-horizontal_small">
                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3 slds-truncate">
                                        <p class="slds-text-body_small slds-text-color_weak slds-p-bottom_xx-small">
                                            <span class="slds-truncate">{!$ObjectType.Lending_Application_Disbursement__c.Fields.Bank_Account_Name__c.Label}</span>
                                            <apex:outputPanel styleClass="fs-required slds-m-left_xx-small">*</apex:outputPanel>
                                        </p>
                                        
                                        <apex:selectList value="{!mAppDisbObject.mDisbursement.Bank_Account_Name__c}"
                                                         multiselect="false" size="1" 
                                                         onchange="handleBankAccountChange();">
                                            <apex:selectOptions value="{!mAppDisbObject.bankAccountList}"/>
                                        </apex:selectList>
                                    </div>

                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3 slds-truncate">
                                        <p class="slds-text-body_small slds-text-color_weak slds-p-bottom_xx-small">
                                            <span class="slds-truncate">{!$Label.fscore__bank_account_details_title}</span>
                                        </p>
                                        
                                        <apex:outputPanel >
                                            <apex:repeat value="{!$ObjectType.Bank_Account__c.FieldSets.Bank_Account_View_Fields}"
                                                         var="bankAccountField">
                                                <div class="slds-text-body_small">
                                                    <p><span class="slds-text-color_weak">{!bankAccountField.Label}:</span>&nbsp;
                                                    <apex:outputField value="{!mAppDisbObject.selectedBankAccount[bankAccountField.fieldPath]}"/></p>
                                                </div>
                                            </apex:repeat>
                                        </apex:outputPanel>
                                    </div>
                                </div>
                             </apex:outputPanel>                            

                            <apex:outputPanel id="nonElectonicPaymentInfoPanel" rendered="{!NOT(mAppDisbObject.isElectronicPayment)}">
                                <div class="slds-m-top_small">
                                    <c:sectionHeader label="{!$Label.fscore__disbursement_info_section_title}"
                                                     isEditSectionHeader="true" isModalWindow="true"/>
                                </div>

                                <div id="nonEPmtInfoSection" class="slds-grid slds-wrap slds-m-horizontal_small">
                                    <apex:repeat value="{!$ObjectType.Lending_Application_Disbursement__c.FieldSets.Disbursement_Non_Electronic_Fields}" var="nonEPmtInfo">
	                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3 slds-truncate">
	                                        <p class="slds-text-body_small slds-text-color_weak slds-p-bottom_xx-small">
	                                            <span class="slds-truncate">{!nonEPmtInfo.Label}</span>
                                                <apex:outputPanel rendered="{!OR(nonEPmtInfo.required, nonEPmtInfo.dbRequired)}" 
                                                                  styleClass="fs-required slds-m-left_xx-small">*</apex:outputPanel>
	                                        </p>
                                            <apex:inputField value="{!mAppDisbObject.mDisbursement[nonEPmtInfo.fieldPath]}" required="false"/>
                                        </div>
                                    </apex:repeat>
                                </div>
                            </apex:outputPanel>                            

                            <apex:outputPanel id="additionalInfoPanel" rendered="{!($ObjectType.Lending_Application_Disbursement__c.FieldSets.Additional_Info_Fields.size > 0)}">
                                <div class="slds-m-top_small">
                                    <c:sectionHeader label="{!$Label.fscore__additional_information_block_title}"
                                                     isEditSectionHeader="true" isModalWindow="true"/>
                                </div>
                                
                                <div id="additionalInfoSection" class="slds-grid slds-wrap slds-m-horizontal_small">
                                    <apex:repeat value="{!$ObjectType.Lending_Application_Disbursement__c.FieldSets.Additional_Info_Fields}" var="addlInfo">
	                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3 slds-truncate">
	                                        <p class="slds-text-body_small slds-text-color_weak slds-p-bottom_xx-small">
	                                            <span class="slds-truncate">{!addlInfo.Label}</span>
                                                <apex:outputPanel rendered="{!OR(addlInfo.required, addlInfo.dbRequired)}" 
                                                                  styleClass="fs-required slds-m-left_xx-small">*</apex:outputPanel>
	                                        </p>
                                            <apex:inputField value="{!mAppDisbObject.mDisbursement[addlInfo.fieldPath]}" required="false"/>
                                        </div>
                                    </apex:repeat>
                                </div>
                            </apex:outputPanel>                            

                        </apex:pageBlock>
                    </apex:outputPanel>
                </div>
            
                <!-- Action Functions -->
                <apex:actionFunction name="handlePartyTypeChange" action="{!onPartyTypeChange}"
                                     reRender="messagePanel,disbursementBlockPanel" status="waitStatus"/>
                        
                <apex:actionFunction name="handleCustomerChange" action="{!onCustomerChange}"
                                     reRender="messagePanel,disbursementBlockPanel" status="waitStatus"/>
            
                <apex:actionFunction name="handleAccountChange" action="{!onAccountChange}"
                                     reRender="messagePanel,disbursementBlockPanel" status="waitStatus"/>
            
                <apex:actionFunction name="handleContactChange" action="{!onContactChange}"
                                     reRender="messagePanel,disbursementBlockPanel" status="waitStatus"/>
            
                <apex:actionFunction name="handleFutureFlagChange" action="{!onFutureFlagChange}"
                                     reRender="messagePanel,disbursementBlockPanel" status="waitStatus"/>
               
                <apex:actionFunction name="handlePaymentMethodChange" action="{!onPaymentMethodChange}"
                                     reRender="messagePanel,disbursementBlockPanel" status="waitStatus"/>
               
                <apex:actionFunction name="handleBankAccountChange" action="{!onBankAccountChange}"
                                     reRender="messagePanel,disbursementBlockPanel" status="waitStatus"/>
                <!-- /Action Function -->
            
            </apex:form>
            <c:fsCopyright pageTitle="{!IF(ISBLANK(mAppDisbObject.mDisbursement.Id)
                                         , $Label.New_Lending_App_Disbursement_Title
                                         , ($ObjectType.Lending_Application_Disbursement__c.Fields.Name.Label + mAppDisbObject.mDisbursement.Name))}"/>
        </div>
        
        <c:fsModalWindow /> 
        
        <script src="{!URLFOR($Resource.fs_sticky_header, 'fs_sticky_header.js')}"/>
        <script>
            //This method overrides the standard salesforce setFocusOnLoad so that
            //when the page opens the focus should not go to the date field
            function setFocusOnLoad() {}
        </script>            
    </body>
</apex:page>
