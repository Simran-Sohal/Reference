<apex:page id="restructureTxnEditPage" standardController="Transaction_Processing_Queue__c" 
           extensions="RestructureTxnEditController" tabStyle="Lending_Contract__c"
           standardStylesheets="true" applyHtmlTag="true" docType="html-5.0"  
           title="{!pageTitle} - {!pageSubtitle}">
           
    <head>
        <meta http-equiv="x-ua-compatible" content="ie=edge"/>
        <apex:slds />
        <apex:stylesheet value="{!URLFOR($Resource.fsCore__fs_style, 'fs-style.css')}"/>
        <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js" />
        <script src="{!URLFOR($Resource.fsCore__fs_svg, 'svg4everybody.js')}"/>
        <script>var $j = jQuery.noConflict();</script>
    </head>
    
    <fsCore:collapsibleHeaderCSS />
    <body>
        <div class="slds-scope">
            <apex:form id="restructureTxnForm" styleClass="slds-container_fluid fs-data-form slds-m-bottom_medium">

                <!-- Header -->
                <div class="slds-page-header slds-m-bottom_small" role="banner">
                    <div class="slds-grid slds-grid_align-spread">
                        <div class="slds-col" align="left">
                            <div class="slds-media">
                                <div class="slds-media__figure">
                                    <fsCore:svgIcon iconStyleClass="slds-icon slds-icon_large slds-icon-standard-task"
                                                    iconPath="{!URLFOR($Asset.SLDS, 'assets/icons/standard-sprite/svg/symbols.svg#service_contract')}"/>
                                </div>
                                <div class="slds-media__body slds-align-middle">
                                    <p class="slds-text-heading_label">{!pageTitle}</p>
                                    <h1  class="slds-page-header__title slds-m-right--small slds-truncate slds-align-middle">
                                        {!pageSubtitle}
                                    </h1>
                                </div>
                            </div>
                        </div>
                            
                        <div class="slds-col slds-no-flex slds-align-middle">
                            <apex:commandButton action="{!onPreview}" status="waitStatus"
                                                value="{!$Label.fscore__preview_button}" 
                                                title="{!$Label.fscore__preview_button_tooltip}"
                                                styleClass="slds-button slds-button_brand"
                                                reRender="messagePanel,restructureTxnPanel"/>
                            
                            <apex:commandButton value="{!$Label.fsserv__save_as_draft_button}" 
                                                title="{!$Label.fsserv__save_as_draft_button_tooltip}"
                                                styleClass="slds-button slds-button_brand"
                                                action="{!onSaveAsDraft}" 
                                                status="waitStatus"
                                                reRender="messagePanel,restructureTxnPanel"/>

                            <apex:commandButton value="{!$Label.fsserv__save_and_post_txn_button}" 
                                                title="{!$Label.fsserv__save_and_post_txn_button_tooltip}"
                                                styleClass="slds-button slds-button_brand"
                                                action="{!onPostTxn}" 
                                                status="waitStatus"
                                                reRender="messagePanel,restructureTxnPanel"/>

                            <apex:commandButton immediate="true" action="{!onCancel}"
                                                value="{!$Label.fscore__cancel_button}" 
                                                title="{!$Label.fscore__cancel_button_tooltip}"
                                                styleClass="slds-button slds-button_neutral"/>
                        </div>
                    </div>
                </div>
                <!-- /Header -->
                
                <!-- Message Panel -->
                <apex:outputPanel id="messagePanel" styleClass="fs-message-panel">
                    <apex:pagemessages />
                </apex:outputPanel> 
                <!-- / Message Panel -->
                
                <apex:actionStatus id="waitStatus">
                    <apex:facet name="start">
                        <fsCore:fsSpinner spinnerSize="medium"/>
                    </apex:facet>
                </apex:actionStatus>

                <div class="slds-m-top_small">
                    <div class="slds-box slds-box_x-small">
                        <apex:outputPanel id="restructureTxnPanel">
                            <apex:pageBlock id="restructureTxnBlock" mode="mainDetail" html-class="fs-data-block">
                                
                                <fsCore:collapsibleHeader label="{!$ObjectType.Lending_Contract__c.Label} : {!$Label.fsserv__contract_current_info_section_title}"
                                                          gridClass="slds-grid_align-spread" for="contractCurrentInfoSection" />
                                              
                                <div id="contractCurrentInfoSection" class="slds-m-top_small">
                                    <div class="slds-grid slds-grid_align-spread slds-wrap slds-m-horizontal_small">
                                        <apex:repeat value="{!$ObjectType.Lending_Contract__c.FieldSets.Contract_Restructure_Info_Fields}" var="currInfoField">
                                            <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-large-size_1-of-2 slds-truncate">
                                                <p class="slds-text-body_small slds-text-color_weak">
                                                    <span class="slds-truncate">{!currInfoField.Label}</span>
                                                </p>
                                                <apex:outputField value="{!lendingContract[currInfoField.fieldPath]}"/>
                                            </div>
                                        </apex:repeat>
                                    </div>
                                </div>

                                <div class="slds-m-top_small">
                                    <fsCore:sectionHeader label="{!$Label.fsserv__restructure_txn_info_section_title}"
                                                          isEditSectionHeader="true" isModalWindow="true"/>
                                </div>

                                <div id="restructureTxnInfoSection" class="slds-grid slds-grid_align-spread slds-wrap slds-m-horizontal_small">
                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-large-size_1-of-2 slds-truncate">
                                        <p class="slds-text-body_small slds-text-color_weak">
                                            <span class="slds-truncate">{!$ObjectType.Transaction_Processing_Queue__c.Fields.Transaction_Name__c.Label}</span>
                                        </p>
                                        <apex:outputField value="{!mRestructureTxn.Transaction_Name__c}" />
                                    </div>
                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-large-size_1-of-2 slds-truncate">
                                        <p class="slds-text-body_small slds-text-color_weak">
                                            <span class="slds-truncate">{!$ObjectType.Transaction_Processing_Queue__c.Fields.Transaction_Operation_Type__c.Label}</span>
                                        </p>
                                        <apex:outputField value="{!mRestructureTxn.Transaction_Operation_Type__c}" />
                                    </div>
                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-large-size_1-of-2 slds-truncate">
                                        <p class="slds-text-body_small slds-text-color_weak">
                                            <span class="slds-truncate">{!$ObjectType.Transaction_Processing_Queue__c.Fields.Transaction_Date__c.Label}</span>
                                            <apex:outputPanel styleClass="fs-required slds-m-left_xx-small">*</apex:outputPanel>
                                        </p>
                                        <apex:inputField value="{!mRestructureTxn.Transaction_Date__c}" required="false"/>
                                    </div>
                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-large-size_1-of-2 slds-truncate">
                                        <p class="slds-text-body_small slds-text-color_weak">
                                            <span class="slds-truncate">{!$ObjectType.Transaction_Processing_Queue__c.Fields.Processing_User__c.Label}</span>
                                            <apex:outputPanel styleClass="fs-required slds-m-left_xx-small">*</apex:outputPanel>
                                        </p>
                                        <apex:inputField value="{!mRestructureTxn.Processing_User__c}" required="false"/>
                                    </div>
                                </div>
                                                                                                 
                                <apex:outputPanel id="txnParameterPanel" rendered="{!(mTxnParamObjectList.size > 0)}">
                                    <div class="slds-m-top_small">
                                        <fsCore:sectionHeader label="{!$Label.fsserv__transaction_parameter_section_title}"
                                                              isEditSectionHeader="true" isModalWindow="true"/>
                                    </div>
                                    
                                    <div class="slds-m-horizontal_xx-small">
                                        <apex:dataTable id="txnParameterTable" value="{!mTxnParamObjectList}" var="txnParamObject"
                                                        styleClass="slds-table slds-table_bordered slds-table_striped slds-max-medium-table_stacked-horizontal">  
                                            <apex:column width="10%">
                                                <apex:facet name="header">
                                                    <span class="slds-text-heading_x-small slds-cell-wrap">
                                                        <strong>{!$Label.fscore__serial_number}</strong>
                                                    </span>
                                                </apex:facet>
                                                <apex:outputField value="{!txnParamObject.txnParam.Display_Order__c}" html-class="slds-cell-wrap"/>
                                                <apex:outputText value="."></apex:outputText>
                                            </apex:column>
    
                                            <apex:column width="40%">
                                                <apex:facet name="header">
                                                    <span class="slds-text-heading_x-small slds-cell-wrap">
                                                        <strong>{!$ObjectType.Transaction_Processing_Parameter__c.Fields.Name.Label}</strong>
                                                    </span>
                                                </apex:facet>
                                                <apex:outputField value="{!txnParamObject.txnParam.Name}" html-class="slds-cell-wrap"/>
                                                <apex:outputPanel rendered="{!txnParamObject.txnParam.Is_Required__c}"
                                                                  styleClass="fs-required slds-m-left_xx-small">*</apex:outputPanel>
                                            </apex:column>
                        
                                            <apex:column width="50%">
                                                <apex:facet name="header">
                                                    <span class="slds-text-heading_x-small slds-cell-wrap">
                                                        <strong>{!$ObjectType.Transaction_Processing_Parameter__c.Fields.Value__c.Label}</strong>
                                                    </span>
                                                </apex:facet>
                                                <apex:inputField value="{!txnParamObject.txnParam.String_Value__c}" 
                                                                 rendered="{!AND(txnParamObject.isStringField, NOT(txnParamObject.hasListValues))}"/>
                                                <apex:inputField value="{!txnParamObject.txnParam.Number_Value__c}" 
                                                                 rendered="{!txnParamObject.isNumberField}"/>
                                                <apex:inputField value="{!txnParamObject.txnParam.Currency_Value__c}" 
                                                                 rendered="{!txnParamObject.isCurrencyField}"/>
                                                <apex:inputField value="{!txnParamObject.txnParam.Date_Value__c}" 
                                                                 rendered="{!txnParamObject.isDateField}"/>
                                                <apex:inputField value="{!txnParamObject.txnParam.Boolean_Value__c}" 
                                                                 rendered="{!txnParamObject.isBooleanField}"/>
                                                <apex:selectList value="{!txnParamObject.txnParam.String_Value__c}"
                                                                 multiselect="false" size="1" 
                                                                 rendered="{!AND(txnParamObject.isStringField,txnParamObject.hasListValues)}">
                                                    <apex:selectOptions value="{!txnParamObject.listValues}" />
                                                </apex:selectList>
                                                <apex:selectList value="{!txnParamObject.txnParam.Reference_Value_ID__c}"
                                                                 multiselect="false" size="1" 
                                                                 rendered="{!AND(txnParamObject.isReferenceField, txnParamObject.hasListValues)}">
                                                    <apex:selectOptions value="{!txnParamObject.listValues}" />
                                                </apex:selectList>
                                            </apex:column>
                                        </apex:dataTable>
                                    </div>
                                </apex:outputPanel>
                                
                                <apex:outputPanel rendered="{!NOT(mIsPreviewed)}">
                                    <div class="slds-align_absolute-center slds-m-vertical_large">
                                        <div class="slds-m-horizontal_large">
                                            <div class="slds-scoped-notification slds-media slds-media_center" role="status">
                                                <div class="slds-media__figure">
                                                    <span class="slds-icon_container slds-icon-utility-info" title="information">
                                                        <fsCore:svgIcon iconStyleClass="slds-icon slds-icon_small slds-icon-text-default"
                                                                        iconPath="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#info')}"/>
                                                    </span>
                                                </div>
                                                <div class="slds-media__body">
                                                    <p class="slds-text-body_small slds-text-color_weak">{!$Label.fsserv__preview_result_section_message}</p>
                                                </div>
                                            </div>                                            
                                        </div>
                                    </div>
                                </apex:outputPanel>

                                <apex:outputPanel rendered="{!(mIsPreviewed)}">
                                    <div class="slds-grid slds-grid_align-spread slds-wrap slds-m-top_small">
                                        <!-- Display Restructured Contract field values -->
                                        <div class="slds-size_1-of-1 slds-large-size_1-of-2 slds-m-right_x-small">
                                            <fsCore:sectionHeader label="Restructured Contract"
                                                                  isEditSectionHeader="true" isModalWindow="true"/>
                                            
                                            <div class="slds-grid slds-grid_align-spread slds-wrap slds-m-horizontal_small">
                                                <apex:repeat value="{!$ObjectType.Lending_Contract__c.FieldSets.Contract_Restructure_Result_Fields}" var="resultField">
                                                    <div class="slds-p-horizontal_x-small slds-p-bottom_small slds-size_1-of-1 slds-truncate">
                                                        <p class="slds-text-body_small slds-text-color_weak">
                                                            <span class="slds-truncate">{!resultField.Label}</span>
                                                        </p>
                                                        <apex:outputField value="{!mRestructuredContract[resultField.fieldPath]}"/>
                                                    </div>
                                                </apex:repeat>
                                            </div>
                                        </div>

                                        <!-- Display Restructured Repayments -->
                                        <div class="slds-size_1-of-1 slds-large-size_1-of-2 slds-m-left_x-small slds-border_left">
                                            <fsCore:sectionHeader label="Restructured Repayments"
                                                                  isEditSectionHeader="true" isModalWindow="true"/>
                                            
                                            <div class="slds-scrollable" style="max-height: 335px;">
                                                <apex:dataTable id="repaymentTable" value="{!mRestructuredRepayments}" var="repay"
                                                                styleClass="slds-table slds-table_bordered slds-table_striped">  
                                                    <apex:repeat value="{!$ObjectType.Contract_Repayment__c.FieldSets.Preview_List_Fields}" var="previewField">
                                                        <apex:column>
                                                            <apex:facet name="header">
                                                                <span class="slds-text-heading_x-small slds-cell-wrap">
                                                                    <strong>{!previewField.Label}</strong>
                                                                </span>
                                                            </apex:facet>
                                                            <apex:outputField value="{!repay[previewField.fieldPath]}" html-class="slds-cell-wrap"/>
                                                        </apex:column>
                                                    </apex:repeat>
                                                </apex:dataTable>
                                            </div>
                                        </div>
                                    </div>
                                </apex:outputPanel>

                            </apex:pageBlock>
                        </apex:outputPanel>
                    </div>
                </div>
            </apex:form>
            
            <!-- Footer -->
            <fsCore:fsCopyright pageTitle="{!pageTitle} - {!pageSubtitle}"/>
            <!-- / Footer -->
        </div>
        
        <fsCore:collapsibleHeaderJS />
        <script>
            //This method overrides the standard salesforce setFocusOnLoad so that
            //when the page opens the focus should not go to the date field
            function setFocusOnLoad() {}
        </script>            
    </body>    
</apex:page>
